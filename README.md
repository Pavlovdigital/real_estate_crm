# CRM Недвижимость (Real Estate CRM)

Это веб-приложение CRM для управления объектами недвижимости, клиентами и сделками, включая функции парсинга объявлений с популярных сайтов.

## Основные функции

- Управление Объектами недвижимости (CRUD)
- Управление Клиентами (CRUD)
- Управление Сделками (CRUD + Канбан доска)
- Парсинг объявлений с OLX.kz и Krisha.kz
- Импорт объектов из Excel
- Экспорт списка объектов в PDF
- Аутентификация пользователей и управление ролями (Администратор, Агент, Пользователь)
- Глобальный поиск по системе
- Пользовательский интерфейс на русском языке с поддержкой тем (светлая/темная)
- Система миграций базы данных с Flask-Migrate

## Установка и запуск

### Требования
- Python 3.10+
- pip (менеджер пакетов Python)
- `wkhtmltopdf` (для экспорта в PDF, см. документацию `pdfkit`)
- Виртуальное окружение (рекомендуется)

### Настройка
1.  **Клонируйте репозиторий:**
    ```bash
    git clone <repository_url>
    cd <repository_name>
    ```

2.  **Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv venv
    source venv/bin/activate  # Для Linux/macOS
    # venv\Scripts\activate    # Для Windows
    ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

4.  **Настройте переменные окружения:**
    Скопируйте файл `.env.example` в `.env` и заполните необходимые значения:
    ```bash
    cp .env.example .env
    # Откройте .env и отредактируйте значения
    ```
    Ключевые переменные:
    - `SECRET_KEY`: Секретный ключ Flask для сессий. **Обязательно измените на случайное значение!**
    - `WTF_CSRF_SECRET_KEY`: Секретный ключ для CSRF защиты форм. **Обязательно измените!**
    - `DATABASE_URL`: URL для подключения к базе данных.
        - По умолчанию используется SQLite (`sqlite:///site.db` в корне проекта).
        - Для PostgreSQL, формат: `postgresql://username:password@host:port/database_name`.
          Пример: `DATABASE_URL="postgresql://crmuser:crmpassword@localhost:5432/crm_database"`
        - Если `DATABASE_URL` не указана, приложение автоматически будет использовать SQLite.

5.  **Примените миграции базы данных:**
    ```bash
    flask db upgrade
    ```

6.  **Создайте начальные роли и администратора (если необходимо):**
    - Для создания ролей (Admin, Agent, User), если они не были созданы миграцией:
      ```bash
      python seed_roles.py 
      ```
    - Для создания первого администратора:
      ```bash
      flask create-admin --username=youradmin --email=admin@example.com --password=yourpassword
      ```
      (Вам будет предложено ввести данные в консоли)

### Запуск приложения
```bash
flask run
# или
python run.py
```
Приложение будет доступно по адресу `http://127.0.0.1:5000/`.

## Структура проекта (основные компоненты)
- `run.py`: Точка входа для запуска приложения и регистрации CLI команд.
- `config.py`: Конфигурация приложения.
- `app/`: Основной пакет приложения.
    - `__init__.py`: Инициализация Flask приложения, расширений, регистрация Blueprint'ов.
    - `models.py`: Модели SQLAlchemy для базы данных.
    - `forms.py`: Формы WTForms.
    - `routes.py`: Основные маршруты приложения (например, главная, поиск).
    - `admin_bp.py`: Blueprint для административной панели (парсер, управление пользователями).
    - `client_bp.py`: Blueprint для управления клиентами.
    - `deal_bp.py`: Blueprint для управления сделками.
    - `matching_bp.py`: Blueprint для подбора объектов клиентам.
    - `services/`: Сервисный слой (например, `parser_service.py`).
    - `scrapers/`: Модули парсеров (например, `olx_scraper.py`).
    - `static/`: Статические файлы (CSS, JavaScript, изображения).
    - `templates/`: HTML шаблоны Jinja2.
- `migrations/`: Файлы миграций Alembic (Flask-Migrate).
- `instance/`: Инстанс-папка Flask (для SQLite БД, загруженных файлов и т.д., не версионируется).
- `requirements.txt`: Список зависимостей Python.
- `.flaskenv`: Переменные окружения для `flask` CLI.
- `.env.example`: Пример файла переменных окружения.

## Дополнительно
- **Парсеры:** Функции парсинга для OLX.kz и Krisha.kz находятся в `app/scrapers/`. Они вызываются через административную панель.
- **Экспорт в PDF:** Для корректной работы экспорта объектов в PDF убедитесь, что утилита `wkhtmltopdf` установлена в вашей системе и доступна в PATH.
```
