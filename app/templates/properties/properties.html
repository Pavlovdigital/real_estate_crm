{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ title }}</h2>
        <div>
            <a href="{{ url_for('filter_properties') }}" class="btn btn-outline-primary me-2"><i class="bi bi-filter-circle"></i> Фильтр объектов</a>
            <a href="{{ url_for('import_properties') }}" class="btn btn-outline-info me-2"><i class="bi bi-file-earmark-excel"></i> Импорт из Excel</a>
            <a href="{{ url_for('export_properties_pdf') }}" class="btn btn-outline-danger me-2"><i class="bi bi-file-earmark-pdf"></i> Экспорт в PDF</a>
            <a href="{{ url_for('add_property') }}" class="btn btn-success"><i class="bi bi-plus-lg"></i> Добавить объект</a>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if properties %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-light">
                <tr>
                    <th style="width: 5%;">Фото</th>
                    <th>ID</th>
                    <th>Название</th>
                    <th>Адрес/Улица</th>
                    <th>Район</th>
                    <th class="text-end">Цена (тг)</th>
                    <th class="text-end">Площадь (м²)</th>
                    <th>Этаж/Этажность</th>
                    <th>Год</th>
                    <th>Источник</th>
                    <th>Статус</th>
                    <th class="text-end">Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for prop in properties %} 
                <tr>
                    <td>
                        {% if prop.images and prop.images.first() %}
                            <img src="{{ url_for('serve_property_image', image_id=prop.images.first().id) }}"
                                 alt="{{ prop.images.first().filename or prop.name }}"
                                 class="img-thumbnail property-list-thumbnail"
                                 style="max-width: 60px; max-height: 60px; cursor:pointer; object-fit: cover;"
                                 data-bs-toggle="modal" 
                                 data-bs-target="#imageGalleryModal"
                                 data-property-id="{{ prop.id }}" {# Used to fetch all images for this property #}
                                 data-current-image-index="0" {# Index of this specific thumbnail #}
                                 data-image-urls="{{ prop.images | map(attribute='id') | map('url_for', endpoint='serve_property_image', image_id=_) | list | tojson | safe }}"
                                 data-image-filenames="{{ prop.images | map(attribute='filename') | list | tojson | safe }}">
                        {% else %}
                            <span class="text-muted small">Нет фото</span>
                        {% endif %}
                    </td>
                    <td>{{ prop.id }}</td>
                    <td><a href="{{ url_for('view_property', property_id=prop.id) }}">{{ prop.name | truncate(30, true) }}</a></td>
                    <td>{{ prop.street | default(prop.address | default('-', true) | truncate(35, true)) }}</td>
                    <td>{{ prop.district | default('-', true) }}</td>
                    <td class="text-end">{{ "{:,.0f}".format(prop.price).replace(",", " ") if prop.price else '-' }}</td>
                    <td class="text-end">{{ prop.area | default('-', true) }}</td>
                    <td class="text-center">{{ prop.floor | default('?') }}/{{ prop.total_floors | default('?') }}</td>
                    <td class="text-center">{{ prop.year | default('-', true) }}</td>
                    <td>{{ prop.source | default('-', true) | truncate(10) }}</td>
                    <td><span class="badge rounded-pill bg-info text-dark">{{ prop.status | default('-', true) }}</span></td>
                    <td class="text-end">
                        <a href="{{ url_for('view_property', property_id=prop.id) }}" class="btn btn-xs btn-outline-info" title="Обзор"><i class="bi bi-eye"></i></a>
                        {% if current_user.is_authenticated and (prop.added_by_user_id == current_user.id or (current_user.role and current_user.role.name == 'Admin')) %}
                        <a href="{{ url_for('edit_property', property_id=prop.id) }}" class="btn btn-xs btn-outline-primary ms-1" title="Редактировать"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('delete_property', property_id=prop.id) }}" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-xs btn-outline-danger ms-1" title="Удалить" onclick="return confirm('Вы уверены, что хотите удалить этот объект: {{ prop.name|e }}?');"><i class="bi bi-trash"></i></button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info">
        Пока нет добавленных объектов. <a href="{{ url_for('add_property') }}" class="alert-link">Добавить новый объект?</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
    {{ super() }}
    {% include 'modals/_image_gallery_modal.html' %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/image_gallery.js') }}"></script>
{% endblock %}
