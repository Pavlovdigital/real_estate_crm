{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>{{ property.name | default("Детали объекта") }}</h2>
        <div>
            <a href="{{ url_for('property_history', property_id=property.id) }}" class="btn btn-outline-info btn-sm me-2">
                <i class="bi bi-clock-history"></i> История
            </a>
            {% if current_user.is_authenticated and (property.added_by_user_id == current_user.id or current_user.role.name == 'Admin') %}
            <a href="{{ url_for('edit_property', property_id=property.id) }}" class="btn btn-primary btn-sm me-2"><i class="bi bi-pencil-square"></i> Редактировать</a>
            <form action="{{ url_for('delete_property', property_id=property.id) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Вы уверены, что хотите удалить этот объект?');"><i class="bi bi-trash-fill"></i> Удалить</button>
            </form>
            {% endif %}
        </div>
    </div>

    {% include '_flash_messages.html' %}

    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h5 class="mb-0">Основная информация</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-7">
                    <dl class="row">
                        <dt class="col-sm-4">Название:</dt> <dd class="col-sm-8">{{ property.name | default('-', true) }}</dd>
                        <dt class="col-sm-4">Адрес:</dt> <dd class="col-sm-8">{{ property.address | default('-', true) }}</dd>
                        <dt class="col-sm-4">Улица:</dt> <dd class="col-sm-8">{{ property.street | default('-', true) }}</dd>
                        <dt class="col-sm-4">Дом/Кв. №:</dt> <dd class="col-sm-8">{{ property.d_kv | default('-', true) }}</dd>
                        <dt class="col-sm-4">Район:</dt> <dd class="col-sm-8">{{ property.district | default('-', true) }}</dd>
                        <dt class="col-sm-4">Цена:</dt> <dd class="col-sm-8"><span class="fw-bold fs-5 text-success">{{ "{:,.0f}".format(property.price).replace(",", " ") if property.price else '-' }} тг.</span></dd>
                        <dt class="col-sm-4">Категория:</dt> <dd class="col-sm-8">{{ property.cat | default('-', true) }}</dd>
                        <dt class="col-sm-4">Статус объекта:</dt> <dd class="col-sm-8">{{ property.status | default('-', true) }}</dd>
                    </dl>
                </div>
                <div class="col-md-5">
                     <dl class="row">
                        <dt class="col-sm-5">Общая площадь:</dt> <dd class="col-sm-7">{{ property.area | default('-', true) }} м²</dd>
                        <dt class="col-sm-5">Площадь (S, жилая/доп.):</dt> <dd class="col-sm-7">{{ property.s | default('-', true) }}</dd>
                        <dt class="col-sm-5">Площадь кухни (S_kh):</dt> <dd class="col-sm-7">{{ property.s_kh | default('-', true) }}</dd>
                        <dt class="col-sm-5">Этаж:</dt> <dd class="col-sm-7">{{ property.floor | default('-', true) }} / {{ property.total_floors | default('-', true) }}</dd>
                        <dt class="col-sm-5">Год постройки:</dt> <dd class="col-sm-7">{{ property.year | default('-', true) }}</dd>
                        <dt class="col-sm-5">Планировка:</dt> <dd class="col-sm-7">{{ property.layout | default('-', true) }}</dd>
                        <dt class="col-sm-5">Состояние:</dt> <dd class="col-sm-7">{{ property.condition | default('-', true) }}</dd>
                        <dt class="col-sm-5">Материал стен (М):</dt> <dd class="col-sm-7">{{ property.m | default('-', true)}}</dd>
                        <dt class="col-sm-5">Балкон/Лоджия (БЛКН):</dt> <dd class="col-sm-7">{{ property.blkn | default('-', true)}}</dd>
                        <dt class="col-sm-5">Расположение (P):</dt> <dd class="col-sm-7">{{ property.p | default('-', true)}}</dd>
                        <dt class="col-sm-5">Телефон продавца:</dt> <dd class="col-sm-7">{{ property.seller_phone | default('-', true) }}</dd>
                    </dl>
                </div>
            </div>
            <hr>
            <h6 class="mt-3"><i class="bi bi-text-paragraph"></i> Описание:</h6>
            <p class="text-body-secondary bg-light p-2 rounded" style="white-space: pre-wrap;">{{ property.description | nl2br if property.description else 'Нет описания.' }}</p>
            
            {% if property.images and property.images.count() > 0 %}
                <hr>
                <h6 class="mt-3"><i class="bi bi-images"></i> Фотографии ({{ property.images.count() }}):</h6>
                <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3 mt-2 image-gallery">
                    {% for image in property.images %}
                        <div class="col">
                            <div class="card h-100">
                                <img src="{{ url_for('serve_property_image', image_id=image.id) }}" 
                                     class="img-fluid rounded property-image-thumbnail" {# Ensure class for JS #}
                                     alt="{{ image.filename or 'Фото объекта ' ~ loop.index }}" 
                                     style="max-height: 150px; object-fit: cover; width: 100%; cursor: pointer;"
                                     data-bs-toggle="modal" data-bs-target="#imageGalleryModal"
                                     {# Pass all image data for this property to each thumbnail for the generic JS #}
                                     data-image-urls="{{ property.images | map(attribute='id') | map('url_for', endpoint='serve_property_image', image_id=_) | list | tojson | safe }}"
                                     data-image-filenames="{{ property.images | map(attribute='filename') | list | tojson | safe }}"
                                     data-current-image-index="{{ loop.index0 }}">
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                 <p class="text-muted mt-3">Фотографии отсутствуют.</p>
            {% endif %}
        </div>
        <div class="card-footer text-muted">
             <div class="row">
                <div class="col-md-6">
                    <small>
                        <i class="bi bi-person-fill"></i> Добавил: {{ property.added_by_user.username if property.added_by_user else (property.added_by_user_id if property.added_by_user_id else 'Система/Неизвестно') }} <br>
                        <i class="bi bi-calendar-plus"></i> Добавлено: {{ property.created_at.strftime('%d.%m.%Y %H:%M') if property.created_at else '-'}} <br>
                        <i class="bi bi-calendar-check"></i> Обновлено: {{ property.updated_at.strftime('%d.%m.%Y %H:%M') if property.updated_at else '-'}}
                    </small>
                </div>
                <div class="col-md-6 text-md-end">
                     <small>
                        {% if property.source %}<i class="bi bi-box-arrow-in-down-left"></i> Источник: {{ property.source }} <br>{% endif %}
                        {% if property.link %}<i class="bi bi-link-45deg"></i> <a href="{{ property.link }}" target="_blank" rel="noopener noreferrer" title="{{ property.link }}">Оригинал объявления</a> <br>{% endif %}
                        {% if property.external_id %}<i class="bi bi-key-fill"></i> Внешний ID: {{ property.external_id }} <br>{% endif %}
                        {% if property.last_scraped_at %}<i class="bi bi-stopwatch-fill"></i> Сканировано: {{ property.last_scraped_at.strftime('%d.%m.%Y %H:%M') }}{% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Removed duplicated modal HTML structure, will be included via partial -->
{% endblock %}

{% block modals %}
    {{ super() }} {# Include modals from base if any #}
    {% include 'modals/_image_gallery_modal.html' %}
{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base.html #}
{# The image_gallery.js will be included in base.html or here if specific #}
{# If image_gallery.js is not in base.html, include it: #}
<script src="{{ url_for('static', filename='js/image_gallery.js') }}"></script>
{% endblock %}
